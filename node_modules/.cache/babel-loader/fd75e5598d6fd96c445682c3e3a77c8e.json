{"ast":null,"code":"var _jsxFileName = \"/Users/kshiba01/projects/DX\\u30B5\\u30FC\\u30D2\\u3099\\u30B9/AWS/amplify/amazon-ivs-chime-web-demo-webui-amplify-console/src/components/chimeWeb/RemoteVideoGroup.jsx\",\n    _s = $RefreshSig$();\n\nimport React, { useState, useEffect } from 'react';\nimport PropTypes from 'prop-types';\nimport RemoteVideo from './RemoteVideo';\nimport * as config from '../../config';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst MAX_REMOTE_VIDEOS = config.CHIME_ROOM_MAX_ATTENDEE;\n\nconst RemoteVideoGroup = _ref => {\n  _s();\n\n  let {\n    chime,\n    joinInfo\n  } = _ref;\n  const [roster, setRoster] = useState([]);\n  const [previousRoster, setPreviousRoster] = useState({});\n\n  const findRosterSlot = attendeeId => {\n    let index;\n\n    for (index = 0; index < roster.length; index++) {\n      if (roster[index].attendeeId === attendeeId) {\n        return index;\n      }\n    }\n\n    for (index = 0; index < roster.length; index++) {\n      if (!roster[index].attendeeId) {\n        return index;\n      }\n    }\n\n    return 0;\n  };\n\n  const rosterCallback = newRoster => {\n    if (Object.keys(newRoster).length > 2) {\n      if (config.DEBUG) console.log('More than 2');\n    }\n\n    if (Object.keys(newRoster).length < Object.keys(previousRoster).length) {\n      if (config.DEBUG) console.log('Attendee(s) left');\n      const differ = Object.keys(previousRoster).filter(k => previousRoster[k] !== newRoster[k]);\n      if (config.DEBUG) console.log(differ);\n\n      if (differ.length) {\n        let i;\n\n        for (i in differ) {\n          const index = findRosterSlot(differ[i]);\n          const rosterNew = roster;\n          rosterNew[index] = {\n            videoElement: rosterNew[index].videoElement\n          };\n          setRoster(rosterNew);\n        }\n      }\n    }\n\n    setPreviousRoster(Object.assign({}, newRoster));\n    let attendeeId;\n\n    for (attendeeId in newRoster) {\n      // Exclude self\n      if (attendeeId === joinInfo.Attendee.AttendeeId) {\n        continue;\n      } // exclude empty name\n\n\n      if (!newRoster[attendeeId].name) {\n        continue;\n      }\n\n      const index = findRosterSlot(attendeeId);\n      const rosterNew = roster;\n      const attendee = { ...rosterNew[index],\n        attendeeId,\n        ...newRoster[attendeeId]\n      };\n      rosterNew[index] = attendee;\n      setRoster(rosterNew);\n    }\n  };\n\n  const videoTileDidUpdateCallback = tileState => {\n    if (!tileState.boundAttendeeId || tileState.localTile || tileState.isContent || !tileState.tileId) {\n      return;\n    }\n\n    let index = findRosterSlot(tileState.boundAttendeeId);\n    const rosterNew = roster;\n    const attendee = { ...rosterNew[index],\n      videoEnabled: tileState.active,\n      attendeeId: tileState.boundAttendeeId,\n      tileId: tileState.tileId\n    };\n    rosterNew[index] = attendee;\n    setRoster(rosterNew);\n    setTimeout(() => {\n      if (config.DEBUG) console.log(rosterNew[index]);\n      const videoElement = document.getElementById(`video_${tileState.boundAttendeeId}`);\n\n      if (videoElement) {\n        chime.audioVideo.bindVideoElement(tileState.tileId, videoElement);\n      }\n    }, 1000);\n  };\n\n  const videoTileWasRemovedCallback = tileId => {\n    let rosterNew = roster; // Find the removed tileId in the roster and mark the video as disabled.\n    // eslint-disable-next-line\n\n    rosterNew.find((o, i) => {\n      if (o.tileId === tileId) {\n        rosterNew[i].videoEnabled = false;\n        setRoster(rosterNew);\n        if (config.DEBUG) console.log(`Tile was removed ${tileId}`);\n      }\n    });\n  };\n\n  useEffect(() => {\n    const rosterNew = []; // eslint-disable-next-line\n\n    Array.from(Array(MAX_REMOTE_VIDEOS).keys()).map((key, index) => {\n      rosterNew[index] = {\n        videoElement: /*#__PURE__*/React.createRef()\n      };\n    });\n    setRoster(rosterNew);\n    chime.subscribeToRosterUpdate(rosterCallback);\n    chime.audioVideo.addObserver({\n      videoTileDidUpdate: videoTileDidUpdateCallback,\n      videoTileWasRemoved: videoTileWasRemovedCallback\n    });\n    return () => {\n      chime.unsubscribeFromRosterUpdate(rosterCallback);\n    };\n  }, []);\n  return /*#__PURE__*/_jsxDEV(React.Fragment, {\n    children: roster.map((attendee, index) => {\n      return /*#__PURE__*/_jsxDEV(RemoteVideo, {\n        chime: chime,\n        attendeeId: attendee.attendeeId,\n        videoEnabled: attendee.videoEnabled,\n        name: attendee.name,\n        muted: attendee.muted,\n        videoElement: attendee.videoElement\n      }, index, false, {\n        fileName: _jsxFileName,\n        lineNumber: 150,\n        columnNumber: 11\n      }, this);\n    })\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 147,\n    columnNumber: 5\n  }, this);\n};\n\n_s(RemoteVideoGroup, \"yZUUY1XLRjrk79tc7LZ8Rw0cXds=\");\n\n_c = RemoteVideoGroup;\nRemoteVideoGroup.propTypes = {\n  chime: PropTypes.object,\n  joinInfo: PropTypes.object\n};\nexport default RemoteVideoGroup;\n\nvar _c;\n\n$RefreshReg$(_c, \"RemoteVideoGroup\");","map":{"version":3,"names":["React","useState","useEffect","PropTypes","RemoteVideo","config","MAX_REMOTE_VIDEOS","CHIME_ROOM_MAX_ATTENDEE","RemoteVideoGroup","chime","joinInfo","roster","setRoster","previousRoster","setPreviousRoster","findRosterSlot","attendeeId","index","length","rosterCallback","newRoster","Object","keys","DEBUG","console","log","differ","filter","k","i","rosterNew","videoElement","assign","Attendee","AttendeeId","name","attendee","videoTileDidUpdateCallback","tileState","boundAttendeeId","localTile","isContent","tileId","videoEnabled","active","setTimeout","document","getElementById","audioVideo","bindVideoElement","videoTileWasRemovedCallback","find","o","Array","from","map","key","createRef","subscribeToRosterUpdate","addObserver","videoTileDidUpdate","videoTileWasRemoved","unsubscribeFromRosterUpdate","muted","propTypes","object"],"sources":["/Users/kshiba01/projects/DXサービス/AWS/amplify/amazon-ivs-chime-web-demo-webui-amplify-console/src/components/chimeWeb/RemoteVideoGroup.jsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\nimport PropTypes from 'prop-types';\nimport RemoteVideo from './RemoteVideo';\nimport * as config from '../../config';\n\nconst MAX_REMOTE_VIDEOS = config.CHIME_ROOM_MAX_ATTENDEE;\n\nconst RemoteVideoGroup = ({ chime, joinInfo }) => {\n  const [roster, setRoster] = useState([]);\n  const [previousRoster, setPreviousRoster] = useState({});\n\n  const findRosterSlot = (attendeeId) => {\n    let index;\n    for (index = 0; index < roster.length; index++) {\n      if (roster[index].attendeeId === attendeeId) {\n        return index;\n      }\n    }\n    for (index = 0; index < roster.length; index++) {\n      if (!roster[index].attendeeId) {\n        return index;\n      }\n    }\n    return 0;\n  };\n\n  const rosterCallback = (newRoster) => {\n    if (Object.keys(newRoster).length > 2) {\n      if (config.DEBUG) console.log('More than 2');\n    }\n\n    if (Object.keys(newRoster).length < Object.keys(previousRoster).length) {\n      if (config.DEBUG) console.log('Attendee(s) left');\n      const differ = Object.keys(previousRoster).filter(\n        (k) => previousRoster[k] !== newRoster[k],\n      );\n      if (config.DEBUG) console.log(differ);\n\n      if (differ.length) {\n        let i;\n        for (i in differ) {\n          const index = findRosterSlot(differ[i]);\n          const rosterNew = roster;\n          rosterNew[index] = {\n            videoElement: rosterNew[index].videoElement,\n          };\n          setRoster(rosterNew);\n        }\n      }\n    }\n\n    setPreviousRoster(Object.assign({}, newRoster));\n\n    let attendeeId;\n    for (attendeeId in newRoster) {\n      // Exclude self\n      if (attendeeId === joinInfo.Attendee.AttendeeId) {\n        continue;\n      }\n\n      // exclude empty name\n      if (!newRoster[attendeeId].name) {\n        continue;\n      }\n\n      const index = findRosterSlot(attendeeId);\n      const rosterNew = roster;\n      const attendee = {\n        ...rosterNew[index],\n        attendeeId,\n        ...newRoster[attendeeId],\n      };\n\n      rosterNew[index] = attendee;\n      setRoster(rosterNew);\n    }\n  };\n\n  const videoTileDidUpdateCallback = (tileState) => {\n    if (\n      !tileState.boundAttendeeId ||\n      tileState.localTile ||\n      tileState.isContent ||\n      !tileState.tileId\n    ) {\n      return;\n    }\n\n    let index = findRosterSlot(tileState.boundAttendeeId);\n    const rosterNew = roster;\n    const attendee = {\n      ...rosterNew[index],\n      videoEnabled: tileState.active,\n      attendeeId: tileState.boundAttendeeId,\n      tileId: tileState.tileId,\n    };\n    rosterNew[index] = attendee;\n    setRoster(rosterNew);\n\n    setTimeout(() => {\n      if (config.DEBUG) console.log(rosterNew[index]);\n      const videoElement = document.getElementById(\n        `video_${tileState.boundAttendeeId}`,\n      );\n      if (videoElement) {\n        chime.audioVideo.bindVideoElement(tileState.tileId, videoElement);\n      }\n    }, 1000);\n  };\n\n  const videoTileWasRemovedCallback = (tileId) => {\n    let rosterNew = roster;\n\n    // Find the removed tileId in the roster and mark the video as disabled.\n    // eslint-disable-next-line\n    rosterNew.find((o, i) => {\n      if (o.tileId === tileId) {\n        rosterNew[i].videoEnabled = false;\n        setRoster(rosterNew);\n        if (config.DEBUG) console.log(`Tile was removed ${tileId}`);\n      }\n    });\n  };\n\n  useEffect(() => {\n    const rosterNew = [];\n    // eslint-disable-next-line\n    Array.from(Array(MAX_REMOTE_VIDEOS).keys()).map((key, index) => {\n      rosterNew[index] = {\n        videoElement: React.createRef(),\n      };\n    });\n    setRoster(rosterNew);\n\n    chime.subscribeToRosterUpdate(rosterCallback);\n\n    chime.audioVideo.addObserver({\n      videoTileDidUpdate: videoTileDidUpdateCallback,\n      videoTileWasRemoved: videoTileWasRemovedCallback,\n    });\n    return () => {\n      chime.unsubscribeFromRosterUpdate(rosterCallback);\n    };\n  }, []);\n\n  return (\n    <React.Fragment>\n      {roster.map((attendee, index) => {\n        return (\n          <RemoteVideo\n            chime={chime}\n            key={index}\n            attendeeId={attendee.attendeeId}\n            videoEnabled={attendee.videoEnabled}\n            name={attendee.name}\n            muted={attendee.muted}\n            videoElement={attendee.videoElement}\n          />\n        );\n      })}\n    </React.Fragment>\n  );\n};\n\nRemoteVideoGroup.propTypes = {\n  chime: PropTypes.object,\n  joinInfo: PropTypes.object,\n};\n\nexport default RemoteVideoGroup;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}