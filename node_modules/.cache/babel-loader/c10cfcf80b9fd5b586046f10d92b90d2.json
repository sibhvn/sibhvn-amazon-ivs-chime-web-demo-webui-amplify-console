{"ast":null,"code":"\"use strict\"; // Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst __1 = require(\"..\");\n\nconst SignalingClientEventType_1 = require(\"../signalingclient/SignalingClientEventType\");\n\nconst SignalingProtocol_js_1 = require(\"../signalingprotocol/SignalingProtocol.js\");\n\nconst BaseTask_1 = require(\"./BaseTask\");\n/**\n * [[PromoteToPrimaryMeetingTask]] sends a `SdkSignalFrame.PrimaryMeetingJoin` and waits for\n * a `SdkSignalFrame.PrimaryMeetingJoinAck`  frame.\n */\n\n\nclass PromoteToPrimaryMeetingTask extends BaseTask_1.default {\n  constructor(context, credentials, completionCallback) {\n    super(context.logger);\n    this.context = context;\n    this.credentials = credentials;\n    this.completionCallback = completionCallback;\n    this.taskName = 'PromoteToPrimaryMeetingTask';\n    this.taskCanceler = null;\n  }\n\n  cancel() {\n    if (this.taskCanceler) {\n      this.taskCanceler.cancel();\n      this.taskCanceler = null;\n    }\n  }\n\n  run() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this.context.signalingClient.ready()) {\n        this.context.signalingClient.promoteToPrimaryMeeting(this.credentials);\n        this.context.logger.info('Sent request to join primary meeting');\n        yield this.receivePrimaryMeetingJoinAck();\n      } else {\n        this.completionCallback(new __1.MeetingSessionStatus(__1.MeetingSessionStatusCode.SignalingRequestFailed));\n      }\n    });\n  }\n\n  receivePrimaryMeetingJoinAck() {\n    return new Promise((resolve, _) => {\n      class Interceptor {\n        constructor(signalingClient, completionCallback, logger) {\n          this.signalingClient = signalingClient;\n          this.completionCallback = completionCallback;\n          this.logger = logger;\n        }\n\n        cancel() {\n          this.signalingClient.removeObserver(this); // Currently only cancel would come from timeout.  Should\n          // be rare enough (ignoring bugs) that we don't need to bother\n          // retrying.\n\n          this.completionCallback(new __1.MeetingSessionStatus(__1.MeetingSessionStatusCode.SignalingRequestFailed));\n          resolve();\n        }\n\n        handleSignalingClientEvent(event) {\n          if (event.isConnectionTerminated()) {\n            this.signalingClient.removeObserver(this);\n            this.logger.info('PromoteToPrimaryMeetingTask connection terminated'); // This would happen either in happy or unhappy disconnections.  The\n            // timing here is rare enough (ignoring bugs) that we don't need to bother\n            // retrying the unhappy case.\n\n            this.completionCallback(new __1.MeetingSessionStatus(__1.MeetingSessionStatusCode.SignalingRequestFailed));\n            resolve();\n          }\n\n          if (event.type === SignalingClientEventType_1.default.ReceivedSignalFrame && event.message.type === SignalingProtocol_js_1.SdkSignalFrame.Type.PRIMARY_MEETING_JOIN_ACK) {\n            this.signalingClient.removeObserver(this);\n            this.logger.info('Got a primary meeting join ACK');\n            this.completionCallback(__1.MeetingSessionStatus.fromSignalFrame(event.message));\n            resolve();\n          }\n        }\n\n      }\n\n      const interceptor = new Interceptor(this.context.signalingClient, this.completionCallback, this.context.logger);\n      this.taskCanceler = interceptor;\n      this.context.signalingClient.registerObserver(interceptor);\n    });\n  }\n\n}\n\nexports.default = PromoteToPrimaryMeetingTask;","map":{"version":3,"mappings":"cAAA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA;;AAKA;;AAEA;;AAEA;AAEA;;;;;;AAIA,MAAqBA,2BAArB,SAAyDC,kBAAzD,CAAiE;EAI/DC,YACUC,OADV,EAEUC,WAFV,EAGUC,kBAHV,EAGoE;IAElE,MAAMF,OAAO,CAACG,MAAd;IAJQ;IACA;IACA;IANA,gBAAW,6BAAX;IACF,oBAAoC,IAApC;EAQP;;EAEDC,MAAM;IACJ,IAAI,KAAKC,YAAT,EAAuB;MACrB,KAAKA,YAAL,CAAkBD,MAAlB;MACA,KAAKC,YAAL,GAAoB,IAApB;IACD;EACF;;EAEKC,GAAG;;MACP,IAAI,KAAKN,OAAL,CAAaO,eAAb,CAA6BC,KAA7B,EAAJ,EAA0C;QACxC,KAAKR,OAAL,CAAaO,eAAb,CAA6BE,uBAA7B,CAAqD,KAAKR,WAA1D;QACA,KAAKD,OAAL,CAAaG,MAAb,CAAoBO,IAApB,CAAyB,sCAAzB;QACA,MAAM,KAAKC,4BAAL,EAAN;MACD,CAJD,MAIO;QACL,KAAKT,kBAAL,CACE,IAAIU,wBAAJ,CAAyBA,6BAAyBC,sBAAlD,CADF;MAGD;IACF;EAAA;;EAEOF,4BAA4B;IAClC,OAAO,IAAIG,OAAJ,CAAY,CAACC,OAAD,EAAUC,CAAV,KAAe;MAChC,MAAMC,WAAN,CAAiB;QACflB,YACUQ,eADV,EAEUL,kBAFV,EAGUC,MAHV,EAGwB;UAFd;UACA;UACA;QACN;;QAEJC,MAAM;UACJ,KAAKG,eAAL,CAAqBW,cAArB,CAAoC,IAApC,EADI,CAEJ;UACA;UACA;;UACA,KAAKhB,kBAAL,CACE,IAAIU,wBAAJ,CAAyBA,6BAAyBC,sBAAlD,CADF;UAGAE,OAAO;QACR;;QAEDI,0BAA0B,CAACC,KAAD,EAA4B;UACpD,IAAIA,KAAK,CAACC,sBAAN,EAAJ,EAAoC;YAClC,KAAKd,eAAL,CAAqBW,cAArB,CAAoC,IAApC;YACA,KAAKf,MAAL,CAAYO,IAAZ,CAAiB,mDAAjB,EAFkC,CAGlC;YACA;YACA;;YACA,KAAKR,kBAAL,CACE,IAAIU,wBAAJ,CAAyBA,6BAAyBC,sBAAlD,CADF;YAGAE,OAAO;UACR;;UAED,IACEK,KAAK,CAACE,IAAN,KAAeC,mCAAyBC,mBAAxC,IACAJ,KAAK,CAACK,OAAN,CAAcH,IAAd,KAAuBI,sCAAeC,IAAf,CAAoBC,wBAF7C,EAGE;YACA,KAAKrB,eAAL,CAAqBW,cAArB,CAAoC,IAApC;YACA,KAAKf,MAAL,CAAYO,IAAZ,CAAiB,gCAAjB;YACA,KAAKR,kBAAL,CAAwBU,yBAAqBiB,eAArB,CAAqCT,KAAK,CAACK,OAA3C,CAAxB;YACAV,OAAO;UACR;QACF;;MAxCc;;MA2CjB,MAAMe,WAAW,GAAG,IAAIb,WAAJ,CAClB,KAAKjB,OAAL,CAAaO,eADK,EAElB,KAAKL,kBAFa,EAGlB,KAAKF,OAAL,CAAaG,MAHK,CAApB;MAKA,KAAKE,YAAL,GAAoByB,WAApB;MACA,KAAK9B,OAAL,CAAaO,eAAb,CAA6BwB,gBAA7B,CAA8CD,WAA9C;IACD,CAnDM,CAAP;EAoDD;;AApF8D;;AAAjEE","names":["PromoteToPrimaryMeetingTask","BaseTask_1","constructor","context","credentials","completionCallback","logger","cancel","taskCanceler","run","signalingClient","ready","promoteToPrimaryMeeting","info","receivePrimaryMeetingJoinAck","__1","SignalingRequestFailed","Promise","resolve","_","Interceptor","removeObserver","handleSignalingClientEvent","event","isConnectionTerminated","type","SignalingClientEventType_1","ReceivedSignalFrame","message","SignalingProtocol_js_1","Type","PRIMARY_MEETING_JOIN_ACK","fromSignalFrame","interceptor","registerObserver","exports"],"sourceRoot":"","sources":["../../src/task/PromoteToPrimaryMeetingTask.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}