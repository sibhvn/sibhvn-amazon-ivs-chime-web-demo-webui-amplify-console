{"ast":null,"code":"\"use strict\"; // Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst loader_1 = require(\"../../libs/voicefocus/loader\");\n\nconst support_1 = require(\"../../libs/voicefocus/support\");\n\nconst ModelSpecBuilder_1 = require(\"../backgroundblurprocessor/ModelSpecBuilder\");\n\nconst DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\n\nconst Versioning_1 = require(\"../versioning/Versioning\");\n/** @internal */\n\n\nconst CREATE_DEFAULT_MODEL_SPEC = () => ModelSpecBuilder_1.default.builder().withSelfieSegmentationDefaults().build();\n/** @internal */\n\n\nconst DEFAULT_CDN = 'https://static.sdkassets.chime.aws';\n/** @internal */\n\nconst DEFAULT_PATHS = {\n  worker: `${DEFAULT_CDN}/bgblur/workers/worker.js`,\n  wasm: `${DEFAULT_CDN}/bgblur/wasm/_cwt-wasm.wasm`,\n  simd: `${DEFAULT_CDN}/bgblur/wasm/_cwt-wasm-simd.wasm`\n};\n\nclass BackgroundFilterVideoFrameProcessor {\n  /**\n   * Based on the SDK version, return an asset group.\n   *\n   * @returns the default asset spec, based on the SDK version.\n   */\n  static defaultAssetSpec() {\n    const version = Versioning_1.default.sdkVersionSemVer;\n    return {\n      assetGroup: `sdk-${version.major}.${version.minor}`\n    };\n  }\n  /**\n   * Set the given parameters to the url. Existing parameters in the url are preserved.\n   * If duplicate parameters exist, they are overwritten, so it's safe to call this method multiple\n   * times on the same url.\n   *\n   * @param url the initial url, can include query parameters\n   * @param queryParams the query parameters to set\n   * @returns a new url with the given query parameters.\n   */\n\n\n  static createUrlWithParams(url, queryParams) {\n    const u = new URL(url);\n    const keys = Object.keys(queryParams);\n\n    for (const key of keys) {\n      if (queryParams[key] !== undefined) {\n        u.searchParams.set(key, queryParams[key]);\n      }\n    }\n\n    return u.toString();\n  }\n  /**\n   * Based on the spec that is passed in set defaults for spec\n   * @param spec the spec that was passed in\n   * @returns An updated spec with defaults set\n   */\n\n\n  static resolveSpec(spec) {\n    const {\n      paths = DEFAULT_PATHS,\n      model = CREATE_DEFAULT_MODEL_SPEC(),\n      assetGroup = this.defaultAssetSpec().assetGroup,\n      revisionID = this.defaultAssetSpec().revisionID\n    } = spec || {};\n    const params = {\n      assetGroup,\n      revisionID,\n      sdk: encodeURIComponent(Versioning_1.default.sdkVersion),\n      ua: encodeURIComponent(Versioning_1.default.sdkUserAgentLowResolution)\n    };\n    paths.worker = this.createUrlWithParams(paths.worker, params);\n    paths.wasm = this.createUrlWithParams(paths.wasm, params);\n    paths.simd = this.createUrlWithParams(paths.simd, params);\n    model.path = this.createUrlWithParams(model.path, params);\n    return {\n      paths,\n      model,\n      assetGroup,\n      revisionID\n    };\n  }\n  /**\n   * Based on the options that are passed in set defaults for options\n   * @param options  the options that are passed in\n   * @returns An updated set of options with defaults set\n   */\n\n\n  static resolveOptions(options) {\n    if (!options.reportingPeriodMillis) {\n      options.reportingPeriodMillis = 1000;\n    }\n\n    const DEFAULT_FILTER_CPU_UTILIZATION = 30;\n\n    if (!options.filterCPUUtilization) {\n      options.filterCPUUtilization = DEFAULT_FILTER_CPU_UTILIZATION;\n    } else if (options.filterCPUUtilization < 0 || options.filterCPUUtilization > 100) {\n      options.logger.warn(`filterCPUUtilization must be set to a range between 0 and 100 percent. Falling back to default of ${DEFAULT_FILTER_CPU_UTILIZATION} percent`);\n      options.filterCPUUtilization = DEFAULT_FILTER_CPU_UTILIZATION;\n    }\n\n    return options;\n  }\n  /**\n   * This method will detect the environment in which it is being used and determine if background\n   * blur/replacement can be used.\n   * @param spec The {@link BackgroundBlurSpec} spec that will be used to initialize assets\n   * @param options options such as logger\n   * @returns a boolean promise that will resolve to true if supported and false if not\n   */\n\n\n  static isSupported(spec, options) {\n    const {\n      logger\n    } = options; // could not figure out how to remove globalThis to test failure case\n\n    /* istanbul ignore next */\n\n    if (typeof globalThis === 'undefined') {\n      logger.info('Browser does not have globalThis.');\n      return Promise.resolve(false);\n    }\n\n    const browser = new DefaultBrowserBehavior_1.default();\n\n    if (!browser.supportsBackgroundFilter()) {\n      logger.info('Browser is not supported.');\n      return Promise.resolve(false);\n    }\n\n    if (!support_1.supportsWASM(globalThis, logger)) {\n      logger.info('Browser does not support WASM.');\n      return Promise.resolve(false);\n    }\n\n    return this.supportsBackgroundFilter(globalThis, spec, logger);\n  }\n\n  static supportsBackgroundFilter() {\n    let scope = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : globalThis;\n    let spec = arguments.length > 1 ? arguments[1] : undefined;\n    let logger = arguments.length > 2 ? arguments[2] : undefined;\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!support_1.supportsWorker(scope, logger)) {\n        logger.info('Browser does not support web workers.');\n        return false;\n      } // Use the actual worker path -- it's only 20KB, and it'll get the cache warm.\n\n\n      const workerURL = spec.paths.worker;\n\n      try {\n        const worker = yield loader_1.loadWorker(workerURL, 'BackgroundFilterWorker', {}, null);\n\n        try {\n          worker.terminate();\n        } catch (e) {\n          logger.info(`Failed to terminate worker. ${e.message}`);\n        }\n\n        return true;\n      } catch (e) {\n        logger.info(`Failed to fetch and instantiate test worker ${e.message}`);\n        return false;\n      }\n    });\n  }\n\n}\n\nexports.default = BackgroundFilterVideoFrameProcessor;","map":{"version":3,"mappings":"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","names":["CREATE_DEFAULT_MODEL_SPEC","ModelSpecBuilder_1","builder","withSelfieSegmentationDefaults","build","DEFAULT_CDN","DEFAULT_PATHS","worker","wasm","simd","BackgroundFilterVideoFrameProcessor","defaultAssetSpec","version","Versioning_1","sdkVersionSemVer","assetGroup","major","minor","createUrlWithParams","url","queryParams","u","URL","keys","Object","key","undefined","searchParams","set","toString","resolveSpec","spec","paths","model","revisionID","params","sdk","encodeURIComponent","sdkVersion","ua","sdkUserAgentLowResolution","path","resolveOptions","options","reportingPeriodMillis","DEFAULT_FILTER_CPU_UTILIZATION","filterCPUUtilization","logger","warn","isSupported","globalThis","info","Promise","resolve","browser","DefaultBrowserBehavior_1","supportsBackgroundFilter","support_1","scope","workerURL","loader_1","terminate","e","message","exports"],"sourceRoot":"","sources":["../../src/backgroundfilter/BackgroundFilterVideoFrameProcessor.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}