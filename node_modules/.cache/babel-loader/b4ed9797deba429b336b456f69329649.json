{"ast":null,"code":"\"use strict\"; // Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst ua_parser_js_1 = require(\"ua-parser-js\");\n\nconst Versioning_1 = require(\"../versioning/Versioning\");\n\nconst flattenEventAttributes_1 = require(\"./flattenEventAttributes\");\n\nclass DefaultEventController {\n  constructor(audioVideoController, eventReporter) {\n    var _a, _b, _c, _d, _e, _f, _g;\n\n    this.audioVideoController = audioVideoController;\n    this.eventReporter = eventReporter;\n    /** @internal */\n\n    this.meetingHistoryStates = [];\n\n    try {\n      this.parserResult = navigator && navigator.userAgent ? new ua_parser_js_1.UAParser(navigator.userAgent).getResult() : null;\n    } catch (error) {\n      // This seems to never happen with ua-parser-js in reality, even with malformed strings.\n\n      /* istanbul ignore next */\n      audioVideoController.logger.error(error.message);\n    }\n\n    this.browserMajorVersion = ((_c = (_b = (_a = this.parserResult) === null || _a === void 0 ? void 0 : _a.browser) === null || _b === void 0 ? void 0 : _b.version) === null || _c === void 0 ? void 0 : _c.split('.')[0]) || DefaultEventController.UNAVAILABLE;\n    this.browserName = ((_d = this.parserResult) === null || _d === void 0 ? void 0 : _d.browser.name) || DefaultEventController.UNAVAILABLE;\n    this.browserVersion = ((_e = this.parserResult) === null || _e === void 0 ? void 0 : _e.browser.version) || DefaultEventController.UNAVAILABLE;\n    this.deviceName = [((_f = this.parserResult) === null || _f === void 0 ? void 0 : _f.device.vendor) || '', ((_g = this.parserResult) === null || _g === void 0 ? void 0 : _g.device.model) || ''].join(' ').trim() || DefaultEventController.UNAVAILABLE;\n  }\n\n  publishEvent(name, attributes) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const timestampMs = Date.now();\n      this.meetingHistoryStates.push({\n        name,\n        timestampMs\n      }); // Make a single frozen copy of the event, reusing the object returned by\n      // `getAttributes` to avoid copying too much.\n\n      const eventAttributes = Object.freeze(Object.assign(this.getAttributes(timestampMs), attributes));\n      this.audioVideoController.forEachObserver(observer => {\n        if (observer.eventDidReceive) {\n          observer.eventDidReceive(name, eventAttributes);\n        }\n      });\n      this.reportEvent(name, timestampMs, attributes);\n    });\n  }\n\n  reportEvent(name, timestampMs, attributes) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function* () {\n      let flattenedAttributes;\n\n      try {\n        if (attributes) {\n          flattenedAttributes = flattenEventAttributes_1.default(attributes);\n        }\n\n        yield (_a = this.eventReporter) === null || _a === void 0 ? void 0 : _a.reportEvent(timestampMs, name, flattenedAttributes);\n      } catch (error) {\n        /* istanbul ignore next */\n        this.audioVideoController.logger.error(`Error reporting event ${error}`);\n      }\n    });\n  }\n\n  pushMeetingState(state) {\n    let timestampMs = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : Date.now();\n    return __awaiter(this, void 0, void 0, function* () {\n      this.meetingHistoryStates.push({\n        name: state,\n        timestampMs\n      });\n      this.reportEvent(state, timestampMs);\n    });\n  }\n\n  getAttributes(timestampMs) {\n    var _a, _b;\n\n    return {\n      attendeeId: this.audioVideoController.configuration.credentials.attendeeId,\n      browserMajorVersion: this.browserMajorVersion,\n      browserName: this.browserName,\n      browserVersion: this.browserVersion,\n      deviceName: this.deviceName,\n      externalMeetingId: typeof this.audioVideoController.configuration.externalMeetingId === 'string' ? this.audioVideoController.configuration.externalMeetingId : '',\n      externalUserId: this.audioVideoController.configuration.credentials.externalUserId,\n      meetingHistory: this.meetingHistoryStates,\n      meetingId: this.audioVideoController.configuration.meetingId,\n      osName: ((_a = this.parserResult) === null || _a === void 0 ? void 0 : _a.os.name) || DefaultEventController.UNAVAILABLE,\n      osVersion: ((_b = this.parserResult) === null || _b === void 0 ? void 0 : _b.os.version) || DefaultEventController.UNAVAILABLE,\n      sdkVersion: Versioning_1.default.sdkVersion,\n      sdkName: Versioning_1.default.sdkName,\n      timestampMs\n    };\n  }\n\n}\n\nexports.default = DefaultEventController;\n/** @internal */\n\nDefaultEventController.UNAVAILABLE = 'Unavailable';","map":{"version":3,"mappings":"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","names":["DefaultEventController","constructor","audioVideoController","eventReporter","parserResult","navigator","userAgent","ua_parser_js_1","getResult","error","logger","message","browserMajorVersion","_a","browser","_b","version","_c","split","UNAVAILABLE","browserName","_d","name","browserVersion","_e","deviceName","_f","device","vendor","_g","model","join","trim","publishEvent","attributes","timestampMs","Date","now","meetingHistoryStates","push","eventAttributes","Object","freeze","assign","getAttributes","forEachObserver","observer","eventDidReceive","reportEvent","flattenedAttributes","flattenEventAttributes_1","pushMeetingState","state","attendeeId","configuration","credentials","externalMeetingId","externalUserId","meetingHistory","meetingId","osName","os","osVersion","sdkVersion","Versioning_1","sdkName","exports"],"sourceRoot":"","sources":["../../src/eventcontroller/DefaultEventController.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}