{"ast":null,"code":"\"use strict\"; // Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst BaseConnectionHealthPolicy_1 = require(\"./BaseConnectionHealthPolicy\");\n\nclass ReconnectionHealthPolicy extends BaseConnectionHealthPolicy_1.default {\n  constructor(logger, configuration, data) {\n    super(configuration, data);\n    this.logger = logger;\n    this.audioDelayPointsOverMaximum = 0;\n    ReconnectionHealthPolicy.CONNECTION_UNHEALTHY_THRESHOLD = configuration.connectionUnhealthyThreshold;\n    ReconnectionHealthPolicy.CONNECTION_WAIT_TIME_MS = configuration.connectionWaitTimeMs;\n    ReconnectionHealthPolicy.MISSED_PONGS_THRESHOLD = configuration.missedPongsUpperThreshold;\n    ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_MS = configuration.maximumAudioDelayMs;\n    ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_DATA_POINTS = configuration.maximumAudioDelayDataPoints;\n  }\n\n  health() {\n    const connectionStartedRecently = this.currentData.isConnectionStartRecent(ReconnectionHealthPolicy.CONNECTION_WAIT_TIME_MS);\n\n    if (connectionStartedRecently) {\n      return 1;\n    }\n\n    const noPacketsReceivedRecently = this.currentData.consecutiveStatsWithNoPackets >= ReconnectionHealthPolicy.CONNECTION_UNHEALTHY_THRESHOLD;\n    const missedPongsRecently = this.currentData.consecutiveMissedPongs >= ReconnectionHealthPolicy.MISSED_PONGS_THRESHOLD;\n\n    if (this.currentData.audioSpeakerDelayMs > ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_MS) {\n      this.audioDelayPointsOverMaximum += 1;\n    } else {\n      this.audioDelayPointsOverMaximum = 0;\n    }\n\n    const hasBadAudioDelay = this.audioDelayPointsOverMaximum > ReconnectionHealthPolicy.MAXIMUM_AUDIO_DELAY_DATA_POINTS;\n\n    if (hasBadAudioDelay) {\n      this.audioDelayPointsOverMaximum = 0;\n    }\n\n    const needsReconnect = noPacketsReceivedRecently || missedPongsRecently || hasBadAudioDelay;\n\n    if (needsReconnect) {\n      this.logger.warn(`reconnection recommended due to: no packets received: ${noPacketsReceivedRecently}, missed pongs: ${missedPongsRecently}, bad audio delay: ${hasBadAudioDelay}`);\n      return 0;\n    }\n\n    return 1;\n  }\n\n}\n\nexports.default = ReconnectionHealthPolicy;","map":{"version":3,"mappings":"cAAA;AACA;;;;;;AAGA;;AAKA,MAAqBA,wBAArB,SACUC,oCADV,CACoC;EAUlCC,YACUC,MADV,EAEEC,aAFF,EAGEC,IAHF,EAG4B;IAE1B,MAAMD,aAAN,EAAqBC,IAArB;IAJQ;IAHF,mCAA8B,CAA9B;IAQNL,wBAAwB,CAACM,8BAAzB,GACEF,aAAa,CAACG,4BADhB;IAEAP,wBAAwB,CAACQ,uBAAzB,GAAmDJ,aAAa,CAACK,oBAAjE;IACAT,wBAAwB,CAACU,sBAAzB,GAAkDN,aAAa,CAACO,yBAAhE;IACAX,wBAAwB,CAACY,sBAAzB,GAAkDR,aAAa,CAACS,mBAAhE;IACAb,wBAAwB,CAACc,+BAAzB,GACEV,aAAa,CAACW,2BADhB;EAED;;EAEDC,MAAM;IACJ,MAAMC,yBAAyB,GAAG,KAAKC,WAAL,CAAiBC,uBAAjB,CAChCnB,wBAAwB,CAACQ,uBADO,CAAlC;;IAGA,IAAIS,yBAAJ,EAA+B;MAC7B,OAAO,CAAP;IACD;;IACD,MAAMG,yBAAyB,GAC7B,KAAKF,WAAL,CAAiBG,6BAAjB,IACArB,wBAAwB,CAACM,8BAF3B;IAGA,MAAMgB,mBAAmB,GACvB,KAAKJ,WAAL,CAAiBK,sBAAjB,IAA2CvB,wBAAwB,CAACU,sBADtE;;IAEA,IAAI,KAAKQ,WAAL,CAAiBM,mBAAjB,GAAuCxB,wBAAwB,CAACY,sBAApE,EAA4F;MAC1F,KAAKa,2BAAL,IAAoC,CAApC;IACD,CAFD,MAEO;MACL,KAAKA,2BAAL,GAAmC,CAAnC;IACD;;IACD,MAAMC,gBAAgB,GACpB,KAAKD,2BAAL,GAAmCzB,wBAAwB,CAACc,+BAD9D;;IAEA,IAAIY,gBAAJ,EAAsB;MACpB,KAAKD,2BAAL,GAAmC,CAAnC;IACD;;IACD,MAAME,cAAc,GAAGP,yBAAyB,IAAIE,mBAA7B,IAAoDI,gBAA3E;;IACA,IAAIC,cAAJ,EAAoB;MAClB,KAAKxB,MAAL,CAAYyB,IAAZ,CACE,yDAAyDR,yBAAyB,mBAAmBE,mBAAmB,sBAAsBI,gBAAgB,EADhK;MAGA,OAAO,CAAP;IACD;;IACD,OAAO,CAAP;EACD;;AAvDiC;;AADpCG","names":["ReconnectionHealthPolicy","BaseConnectionHealthPolicy_1","constructor","logger","configuration","data","CONNECTION_UNHEALTHY_THRESHOLD","connectionUnhealthyThreshold","CONNECTION_WAIT_TIME_MS","connectionWaitTimeMs","MISSED_PONGS_THRESHOLD","missedPongsUpperThreshold","MAXIMUM_AUDIO_DELAY_MS","maximumAudioDelayMs","MAXIMUM_AUDIO_DELAY_DATA_POINTS","maximumAudioDelayDataPoints","health","connectionStartedRecently","currentData","isConnectionStartRecent","noPacketsReceivedRecently","consecutiveStatsWithNoPackets","missedPongsRecently","consecutiveMissedPongs","audioSpeakerDelayMs","audioDelayPointsOverMaximum","hasBadAudioDelay","needsReconnect","warn","exports"],"sourceRoot":"","sources":["../../src/connectionhealthpolicy/ReconnectionHealthPolicy.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}